<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#FAF6F0] text-gray-800">
  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Sales CRM</h1>
      <div class="space-x-2">
        <button id="tabSales" class="px-4 py-2 rounded border bg-white">Sales</button>
        <button id="tabTeam" class="px-4 py-2 rounded border bg-white">Team</button>
      </div>
    </header>

    <section id="viewSales" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Total Revenue</div><div id="kTotalRev" class="font-bold text-lg">$0</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Total Units</div><div id="kTotalUnits" class="font-bold text-lg">0</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Top 20 SKU Share</div><div id="kTop20" class="font-bold text-lg">0%</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Prev 7d Revenue</div><div id="kPrevRev" class="font-bold text-lg">$0</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Prev 7d Units</div><div id="kPrevUnits" class="font-bold text-lg">0</div></div>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <div class="text-sm text-gray-600">Category</div>
        <select id="categoryFilter" class="border px-3 py-2 rounded"><option>All</option></select>
        <div class="text-xs text-gray-500 mt-2">Period: 2025-08-11 → 2025-08-31</div>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <div class="font-semibold mb-2">Summary</div>
        <ul id="ulSummary" class="list-disc pl-6 text-sm"></ul>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <div class="font-semibold mb-2">Tables</div>
        <div class="text-sm text-gray-500">SKU-level exports were not provided, so Movers, Sellers, Sell-Through, and Category Mix tables are empty by design. Upload SKU-level sales to enable them.</div>
      </div>
    </section>

    <section id="viewTeam" class="space-y-4 hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Total Revenue</div><div id="tTotalRev" class="font-bold text-lg">$0</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Total Units</div><div id="tTotalUnits" class="font-bold text-lg">0</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Top Rep (Revenue)</div><div id="tTopRepRev" class="font-bold text-lg">—</div></div>
        <div class="p-4 bg-white rounded shadow"><div class="text-xs text-gray-500">Top Rep (TWE)</div><div id="tTopRepTWE" class="font-bold text-lg">—</div></div>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <div class="font-semibold mb-2">Sales Team CRM Prototype (Jul 1 – Aug 31, 2025)</div>
        <div class="overflow-x-auto">
          <table id="tblTeam" class="min-w-full">
            <thead><tr>
              <th class="text-left p-2">Name</th><th class="text-left p-2">Revenue</th><th class="text-left p-2">Units</th>
              <th class="text-left p-2">Avg Ticket</th><th class="text-left p-2">% of Sales</th><th class="text-left p-2">Hours</th><th class="text-left p-2">TWE</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="teamNotes" class="text-xs text-gray-500 mt-2"></div>
      </div>
    </section>
  </div>

  <script>
    const fmtCurrency = n => isFinite(n) ? (n<0? "-$":"$")+Math.abs(n).toLocaleString(undefined, {maximumFractionDigits:0}) : "—";
    const fmtInt = n => isFinite(n) ? Number(n).toLocaleString() : "—";
    const fmtPct = n => isFinite(n) ? (n*100).toFixed(1)+"%" : "—";
    const el = id => document.getElementById(id);

    function setActive(tab){
      el("viewSales").classList.toggle("hidden", tab!=="sales");
      el("viewTeam").classList.toggle("hidden", tab!=="team");
    }
    document.getElementById("tabSales").onclick = ()=>setActive("sales");
    document.getElementById("tabTeam").onclick = ()=>setActive("team");

    Promise.all([
      fetch('sales_crm_sku_data.json').then(r=>r.json()).catch(()=>null),
      fetch('team_metrics.json').then(r=>r.json()).catch(()=>null)
    ]).then(([s,t])=>{
      if(s){
        el("kTotalRev").textContent = fmtCurrency(s.kpis.total_revenue||0);
        el("kTotalUnits").textContent = fmtInt(s.kpis.total_units||0);
        el("kTop20").textContent = fmtPct(s.kpis.top20_sku_share_pct||0);
        el("kPrevRev").textContent = fmtCurrency(s.kpis.prev_week_revenue||0);
        el("kPrevUnits").textContent = fmtInt(s.kpis.prev_week_units||0);
        const ul = el("ulSummary");
        ul.innerHTML = "";
        const li = txt => { const li=document.createElement("li"); li.textContent=txt; ul.appendChild(li); };
        li(`Prev 7d totals: Revenue ${(s.kpis.prev_week_revenue||0).toLocaleString()}, Units ${(s.kpis.prev_week_units||0).toLocaleString()}`);
        if(s.data_notes && s.data_notes.note) li(s.data_notes.note);
      }
      if(t){
        el("tTotalRev").textContent = fmtCurrency(t.kpis.total_revenue||0);
        el("tTotalUnits").textContent = fmtInt(t.kpis.total_units||0);
        const trr = t.kpis.top_rep_revenue||{name:"—",revenue:0};
        const trt = t.kpis.top_rep_twe||{name:"—",twe:0};
        el("tTopRepRev").textContent = `${trr.name} (${fmtCurrency(trr.revenue)})`;
        el("tTopRepTWE").textContent = `${trt.name} (${isFinite(trt.twe)? t.kpis.top_rep_twe.twe.toFixed(3): "—"})`;

        const tbody = el("tblTeam").querySelector("tbody");
        tbody.innerHTML = "";
        for(const r of (t.reps||[])){
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="p-2">${r.name}</td>
                          <td class="p-2">${fmtCurrency(r.revenue)}</td>
                          <td class="p-2">${fmtInt(r.units)}</td>
                          <td class="p-2">${(r.avg_ticket||0).toFixed(2)}</td>
                          <td class="p-2">${fmtPct(r.share_sales_pct||0)}</td>
                          <td class="p-2">${(r.hours||0).toFixed(1)}</td>
                          <td class="p-2">${isFinite(r.twe)? r.twe.toFixed(3): "—"}</td>`;
          tbody.appendChild(tr);
        }
        el("teamNotes").textContent = (t.notes||[]).map(x=>"- "+x).join("\n");
      }
    }).catch(e=>alert("Error loading data"));
  </script>
</body>
</html>
