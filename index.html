<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and Recharts for charts -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <style>
    :root{--cream:#faf6f0;--coral:#ff6f61;--mint:#74d4b4;--ink:#1f2937}
    body{background:var(--cream);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    .hover-glow:hover{box-shadow:0 10px 30px rgba(116,212,180,.35)}
    .btn-tab{padding:10px 16px;border-radius:9999px;background:#fff;border:1px solid #e5e7eb}
    .btn-tab.active{border-color:var(--mint);color:#065f46;box-shadow:0 0 0 3px rgba(116,212,180,.25) inset}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .label{font-size:12px;color:#6b7280}
    .kpi .value{font-size:20px;font-weight:700}
    .scroll-x{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;white-space:nowrap}
    th{text-align:left;font-weight:600}
    .no-data{color:#9ca3af;font-style:italic}
    .tag-mint{color:var(--mint)} .tag-coral{color:var(--coral)}
    .chip{display:inline-block;padding:2px 8px;border-radius:9999px;background:#f3f4f6;font-size:12px}
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">Sales CRM</h1>
      <div class="flex gap-2">
        <button id="tabSales" class="btn-tab active">Sales</button>
        <button id="tabTeam" class="btn-tab">Team</button>
      </div>
    </header>

    <!-- Sales View -->
    <section id="viewSales" class="space-y-6">
      <!-- KPIs -->
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="card p-4 hover-glow kpi"><span class="label">Total Revenue</span><span id="kTotalRev" class="value">$0</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Total Units</span><span id="kTotalUnits" class="value">0</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Total Profit</span><span id="kTotalProfit" class="value">$0</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Top 20 SKU Share</span><span id="kTop20" class="value">0%</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Prev 7d Revenue</span><span id="kPrevRev" class="value">$0</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Prev 7d Units</span><span id="kPrevUnits" class="value">0</span></div>
      </div>

      <!-- Category Filter -->
      <div class="card p-4 hover-glow flex items-center gap-4">
        <label class="text-sm text-gray-600">Category</label>
        <select id="categoryFilter" class="border rounded px-3 py-2"><option value="__ALL__">All</option></select>
        <span id="periodChip" class="chip">Period</span>
      </div>

      <!-- Top 5 Profit Chart -->
      <div class="card p-4 hover-glow">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Top 5 SKUs in Profit</h2>
        </div>
        <div id="chartProfit5" class="w-full" style="height:600px;"></div>
      </div>

      <!-- Movers section removed -->

      <!-- Sellers (Revenue) and Profit Leaderboards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Top Sellers (Revenue)</h2>
          <div class="scroll-x"><table id="tblTopRev"><thead>
            <tr><th>Product</th><th>Category</th><th>Units</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Bottom Sellers (Revenue)</h2>
          <div class="scroll-x"><table id="tblBottomRev"><thead>
            <tr><th>Product</th><th>Brand</th><th>Category</th><th>Units</th><th>Revenue</th><th>Profit</th><th>Margin</th><th>% of Total</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
      </div>

      <!-- Profit Leaderboards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Top by Profit</h2>
          <div class="scroll-x"><table id="tblTopProfit"><thead>
            <tr><th>Product</th><th>Brand</th><th>Category</th><th>Units</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Bottom by Profit</h2>
          <div class="scroll-x"><table id="tblBottomProfit"><thead>
            <tr><th>Product</th><th>Brand</th><th>Category</th><th>Units</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
      </div>

      <!-- Sell-Through -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Sell-Through — Top</h2>
          <div class="scroll-x"><table id="tblSTop"><thead>
            <tr><th>Product</th><th>Brand</th><th>Units Sold</th><th>Received</th><th>Sell-Through</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Sell-Through — Bottom</h2>
          <div class="scroll-x"><table id="tblSBot"><thead>
            <tr><th>Product</th><th>Brand</th><th>Units Sold</th><th>Received</th><th>Sell-Through</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
      </div>

      <!-- Most & Least Units -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Most Sold (Units)</h2>
          <div class="scroll-x"><table id="tblMostUnits"><thead>
            <tr><th>Product</th><th>Brand</th><th>Category</th><th>Units</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Least Sold (Units)</h2>
          <div class="scroll-x"><table id="tblLeastUnits"><thead>
            <tr><th>Product</th><th>Brand</th><th>Category</th><th>Units</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
      </div>

      <!-- Category Mix (Revenue & Profit) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Category Mix (Revenue)</h2>
          <div class="scroll-x"><table id="tblCatMixRev"><thead>
            <tr><th>Category</th><th>Revenue</th><th>Units</th><th>% of Revenue</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
        <div class="card p-4 hover-glow">
          <h2 class="font-semibold mb-2">Category Mix (Profit)</h2>
          <div class="scroll-x"><table id="tblCatMixProfit"><thead>
            <tr><th>Category</th><th>Profit</th><th>Units</th><th>% of Profit</th></tr>
          </thead><tbody></tbody></table></div>
        </div>
      </div>

      <!-- Loyalty -->
      <div class="card p-4 hover-glow">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Loyalty — Frequent Flyers</h2>
          <span class="text-xs text-gray-500">Action disabled (mailto in config)</span>
        </div>
        <div class="scroll-x"><table id="tblLoyalty"><thead>
          <tr><th>Budtender</th><th>Store</th><th>Count</th><th>Progress</th><th>Action</th></tr>
        </thead><tbody></tbody></table></div>
      </div>

      <!-- Summary & Insights -->
      <div class="card p-4 hover-glow">
        <h2 class="font-semibold mb-2">Summary & Insights</h2>
        <ul id="ulSummary" class="list-disc pl-6 space-y-1 text-sm"></ul>
      </div>
    </section>2
    <!-- Team View -->
    <section id="viewTeam" class="space-y-6 hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4 hover-glow kpi"><span class="label">Total Revenue</span><span id="tTotalRev" class="value">$0</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Total Units</span><span id="tTotalUnits" class="value">0</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Top Rep (Revenue)</span><span id="tTopRepRev" class="value">—</span></div>
        <div class="card p-4 hover-glow kpi"><span class="label">Top Rep (TWE)</span><span id="tTopRepTWE" class="value">—</span></div>
      </div>
      <div class="card p-4 hover-glow">
        <h2 class="font-semibold mb-2">Sales Team CRM Prototype (Jul 1 – Aug 31, 2025)</h2>
        <div class="scroll-x"><table id="tblTeam"><thead>
          <tr><th>Name</th><th>Revenue</th><th>Units</th><th>Avg Ticket</th><th>% of Sales</th><th>Hours</th><th>TWE</th></tr>
        </thead><tbody></tbody></table></div>
        <div id="teamNotes" class="text-xs text-gray-500 mt-2"></div>
      </div>
    </section>
  </div>

  <!-- JavaScript for functionality -->
  <script>
    const fmtCurrency = n => isFinite(n) ? (n < 0 ? "-$" : "$") + Math.abs(n).toLocaleString(undefined,{maximumFractionDigits:0}) : "—";
    const fmtInt = n => isFinite(n) ? Number(n).toLocaleString() : "—";
    const fmtPct = n => isFinite(n) ? (n*100).toFixed(1) + "%" : "—";
    const el = id => document.getElementById(id);

    function setActive(tab){
      document.getElementById("tabSales").classList.toggle("active", tab === "sales");
      document.getElementById("tabTeam").classList.toggle("active", tab === "team");
      document.getElementById("viewSales").classList.toggle("hidden", tab !== "sales");
      document.getElementById("viewTeam").classList.toggle("hidden", tab !== "team");
    }
    document.getElementById("tabSales").onclick = () => setActive("sales");
    document.getElementById("tabTeam").onclick = () => setActive("team");

let salesData = null, loyaltyRows = [], loyaltyCfg = null, teamData = null, currentCategory = "__ALL__";
// No chart mode needed for Top 5 Profit chart

// Cache-buster to avoid serving stale JSON from GitHub Pages
const cacheBust = '?v=' + Date.now();

// Display errors inline in the UI so users understand what's wrong
function showError(msg) {
  console.error(msg);
  // Insert error banner before chartProfit5 if present; fallback to body
  const anchor = document.querySelector('#chartProfit5') || document.body;
  const div = document.createElement('div');
  div.style.background = '#fee2e2';
  div.style.color = '#991b1b';
  div.style.padding = '10px';
  div.style.border = '1px solid #ef4444';
  div.style.borderRadius = '8px';
  div.style.margin = '10px 0';
  div.textContent = 'Data error: ' + msg;
  anchor.parentNode.insertBefore(div, anchor);
}

// -----------------------------------------------------------------------------
// Robust JSON loader with sanitation and fallback values
// sanitizeJson fixes a few common invalid patterns in GitHub‑served JSONs:
//  - collapses ": - 1" (minus followed by space and number) into ": -1"
//  - replaces Unicode minus signs with normal ASCII '-'
//  - converts stray NaN tokens into null
//  - converts lone minus (e.g., ": -," or ": -}") into zero
function sanitizeJson(text) {
  return text
    // collapse minus followed by whitespace and digits (e.g., ": - 3" → ": -3")
    .replace(/(:\s*)-\s+([0-9])/g, '$1-$2')
    // replace various Unicode minus/dash characters with ASCII hyphen
    .replace(/[\u2010-\u2015\u2212]/g, '-')
    // convert literal NaN tokens to null
    .replace(/\bNaN\b/g, 'null')
    // convert lone minus (e.g., ": -," or ": -}") into zero
    .replace(/(:\s*)-(\s*[,}])/g, '$10$2');
}

function getJSON(url, fallback) {
  return fetch(url + cacheBust, { cache: 'no-store' })
    .then(r => {
      if (!r.ok) throw new Error(url + ' → ' + r.status + ' ' + r.statusText);
      return r.text();
    })
    .then(txt => {
      try {
        return JSON.parse(sanitizeJson(txt));
      } catch (e) {
        throw new Error(url + ' → ' + e.message);
      }
    })
    .catch(err => {
      // Show error but return fallback so other datasets may still render
      showError(err.message);
      return fallback;
    });
}

// Load all datasets with sensible defaults; render only after all fetches settle
Promise.all([
  getJSON('sales_crm_sku_data.json', null),
  getJSON('loyalty_signups.json', []),
  getJSON('loyalty_config.json', null),
  getJSON('team_sales_kpis.json', null)
  getJSON('team_sales_kpis.schema.json',) 
]).then(([s,l,c,t]) => {
  salesData = s || {};
  loyaltyRows = Array.isArray(l) ? l : [];
  loyaltyCfg = c || { threshold: 10 };
  teamData = t || null;
  if (typeof renderSales === 'function') renderSales();
  if (typeof renderTeam === 'function') renderTeam();
});

// Catch unexpected errors globally
window.addEventListener('error', e => showError(e.message));

    function renderSales(){
      if(!salesData) return;
      const k = salesData.kpis || {};
      el("kTotalRev").textContent = fmtCurrency(k.total_revenue || 0);
      el("kTotalUnits").textContent = fmtInt(k.total_units || 0);
      el("kTotalProfit").textContent = fmtCurrency(k.total_profit || 0);
      el("kTop20").textContent = fmtPct(k.top20_sku_share_pct || 0);
      el("kPrevRev").textContent = fmtCurrency(k.prev_week_revenue || 0);
      el("kPrevUnits").textContent = fmtInt(k.prev_week_units || 0);
      el("periodChip").textContent = `Period: ${salesData.data_notes?.period_start || ""} → ${salesData.data_notes?.period_end || ""}`;
      // Category dropdown
      const sel = document.getElementById("categoryFilter");
      // populate categories once
      if(sel.options.length === 1) {
        const cats = (salesData.category_mix || []).map(r => r.category).filter(Boolean);
        [...new Set(cats)].sort().forEach(c => {
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c; sel.appendChild(opt);
        });
      }
      sel.onchange = () => {
        currentCategory = sel.value;
        drawTables(); drawSummary(); buildTopProfitChart(getTop5ProfitChartRows(), "chartProfit5");
      };
      drawTables(); drawSummary(); buildTopProfitChart(getTop5ProfitChartRows(), "chartProfit5");
    }

    function passCat(r){ return currentCategory === "__ALL__" ? true : (r.category || "") === currentCategory; }

    function drawTableRows(tbody, rows, cols){
      tbody.innerHTML = "";
      let any = false;
      for(const r of (rows || [])){
        if('category' in r && !passCat(r)) continue;
        const tr = document.createElement("tr");
        cols.forEach(c => {
          const td = document.createElement("td"); let v = r[c];
          if(c === 'revenue' || c === 'profit') v = fmtCurrency(v);
          if(c === 'units' || c === 'units_received') v = fmtInt(v);
          if(c === 'pct_total' || c === 'margin_pct') v = (v == null) ? '—' : fmtPct(v);
          if(c === 'sell_through' || c === 'W3_vs_W1') v = (v == null) ? '—' : (v*100).toFixed(1) + '%';
          td.textContent = v; tr.appendChild(td);
        });
        tbody.appendChild(tr); any = true;
      }
      if(!any){
        const tr = document.createElement("tr");
        const td = document.createElement("td"); td.colSpan = cols.length; td.className = "no-data"; td.textContent = "No data"; tr.appendChild(td); tbody.appendChild(tr);
      }
    }

    function drawTables(){
      // Movers tables have been removed; skip drawing these tables
      drawTableRows(document.querySelector("#tblTopRev tbody"), salesData.sku_top_revenue, ["product","Brand","category","units","revenue","profit","margin_pct","pct_total"]);
      drawTableRows(document.querySelector("#tblBottomRev tbody"), salesData.sku_bottom_revenue, ["product","Brand","category","units","revenue","profit","margin_pct","pct_total"]);
      drawTableRows(document.querySelector("#tblTopProfit tbody"), salesData.sku_top_profit, ["product","Brand","category","units","revenue","profit","margin_pct"]);
      drawTableRows(document.querySelector("#tblBottomProfit tbody"), salesData.sku_bottom_profit, ["product","Brand","category","units","revenue","profit","margin_pct"]);
      drawTableRows(document.querySelector("#tblSTop tbody"), salesData.sku_sellthrough_top, ["product","Brand","units","units_received","sell_through","revenue","profit","margin_pct"]);
      drawTableRows(document.querySelector("#tblSBot tbody"), salesData.sku_sellthrough_bottom, ["product","Brand","units","units_received","sell_through","revenue","profit","margin_pct"]);
      drawTableRows(document.querySelector("#tblMostUnits tbody"), salesData.sku_most_units, ["product","Brand","category","units","revenue","profit","margin_pct"]);
      drawTableRows(document.querySelector("#tblLeastUnits tbody"), salesData.sku_least_units, ["product","Brand","category","units","revenue","profit","margin_pct"]);
      // Category mix tables
      drawTableRows(document.querySelector("#tblCatMixRev tbody"), salesData.category_mix, ["category","revenue","units","percentage"]);
      drawTableRows(document.querySelector("#tblCatMixProfit tbody"), salesData.category_mix_profit, ["category","profit","units","percentage"]);
      // Loyalty table
      const threshold = (loyaltyCfg && loyaltyCfg.threshold) ? loyaltyCfg.threshold : 10;
      const byBud = {};
      (loyaltyRows || []).forEach(r => {
        const b = r.budtender || 'Unknown'; const s = r.store || '—';
        byBud[b] = byBud[b] || {store:s,count:0}; byBud[b].count += 1;
      });
      const rows = Object.entries(byBud).map(([b,v]) => ({budtender:b, store:v.store, count:v.count, progress: Math.min(1, v.count/threshold) })).sort((a,b) => b.count - a.count);
      const tb = document.querySelector("#tblLoyalty tbody"); tb.innerHTML = "";
      if(rows.length === 0){
        const tr = document.createElement("tr"); const td = document.createElement("td"); td.colSpan = 5; td.className = "no-data"; td.textContent = "No data"; tr.appendChild(td); tb.appendChild(tr);
      } else {
        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.budtender}</td><td>${r.store}</td><td>${fmtInt(r.count)}</td><td>${(r.progress*100).toFixed(0)}%</td><td><button class="px-2 py-1 rounded bg-gray-200 text-gray-500 cursor-not-allowed" disabled>Redeem</button></td>`;
          tb.appendChild(tr);
        });
      }
    }

    function drawSummary(){
      const ul = document.getElementById("ulSummary"); ul.innerHTML = "";
      const prev = (salesData.category_mix_prev_week || []).slice().sort((a,b) => b.revenue - a.revenue);
      const top3 = prev.slice(0,3), bottom3 = prev.slice(-3);
      const prevRev = salesData.kpis?.prev_week_revenue || 0, prevUnits = salesData.kpis?.prev_week_units || 0;
      const add = t => { const li = document.createElement("li"); li.textContent = t; ul.appendChild(li); };
      if(top3.length) add(`Top 3 categories (Prev 7d): ${top3.map(x => x.category + ' ' + (x.percentage*100).toFixed(1) + '%').join(', ')}`);
      if(bottom3.length) add(`Bottom 3 categories (Prev 7d): ${bottom3.map(x => x.category + ' ' + (x.percentage*100).toFixed(1) + '%').join(', ')}`);
      add(`Prev 7d totals: Revenue ${fmtCurrency(prevRev)}, Units ${fmtInt(prevUnits)}`);
    }

    function renderTeam(){
      if(!teamData){ document.getElementById("teamNotes").textContent = "Error loading metrics"; return; }
      document.getElementById("tTotalRev").textContent = fmtCurrency(teamData.kpis.total_revenue || 0);
      document.getElementById("tTotalUnits").textContent = fmtInt(teamData.kpis.total_units || 0);
      const trr = teamData.kpis.top_rep_revenue || {name:'—', revenue:0};
      const trt = teamData.kpis.top_rep_twe || {name:'—', twe:0};
      document.getElementById("tTopRepRev").textContent = `${trr.name} (${fmtCurrency(trr.revenue)})`;
      document.getElementById("tTopRepTWE").textContent = `${trt.name} (${isFinite(trt.twe) ? trt.twe.toFixed(3) : '—'})`;
      const tb = document.querySelector("#tblTeam tbody"); tb.innerHTML = "";
      (teamData.reps || []).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.name}</td><td>${fmtCurrency(r.revenue)}</td><td>${fmtInt(r.units)}</td><td>${isFinite(r.avg_ticket) ? r.avg_ticket.toFixed(2) : '—'}</td><td>${fmtPct(r.share_sales_pct)}</td><td>${isFinite(r.hours) ? r.hours.toFixed(1) : '—'}</td><td>${isFinite(r.twe) ? r.twe.toFixed(3) : '—'}</td>`;
        tb.appendChild(tr);
      });
      document.getElementById("teamNotes").textContent = (teamData.notes || []).map(x => '- ' + x).join("\n");
    }

    // Chart helpers
    // Build data rows for Top 5 Profit chart. Returns top 5 SKUs by profit
    function getTop5ProfitChartRows(){
      if(!salesData || !Array.isArray(salesData.sku_top_profit)) return [];
      return salesData.sku_top_profit
        .filter(r => currentCategory === "__ALL__" ? true : ((r.category || '') === currentCategory))
        .slice(0,5)
        .map(r => ({ label: `${r.product}`.slice(0,60), Profit: Number(r.profit || 0) }));
    }
    const currencyFmt = n => isFinite(n) ? (n < 0 ? "-$" : "$") + Math.abs(n).toLocaleString(undefined,{maximumFractionDigits:0}) : "—";
    // Build horizontal bar chart for Top 5 SKUs in Profit. Only renders Profit bars
    function buildTopProfitChart(data, mountId){
      const { ResponsiveContainer, BarChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Bar } = Recharts;
      const root = document.getElementById(mountId);
      if(!root) return;
      const e = React.createElement;
      const chart = e(ResponsiveContainer,{ width:'100%', height:600 },
        e(BarChart,{ data, layout:'vertical', margin:{ top:10, right:30, left:120, bottom:10 } },
          e(CartesianGrid,{ strokeDasharray:'3 3' }),
          e(XAxis,{ type:'number' }),
          e(YAxis,{ dataKey:'label', type:'category', width:220 }),
          e(Tooltip,{ formatter:(v) => currencyFmt(v) }),
          e(Bar,{ dataKey:'Profit', barSize:14 })
        ));
      ReactDOM.render(chart, root);
    }
  </script>
</body>
</html>
